name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 1.2.0) - Only required for custom releases"
        required: false
        type: string
      release_type:
        description: "Type of release"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - custom
      source_branch:
        description: "Source branch (default: develop)"
        required: false
        default: "develop"
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release-branch:
    name: Create Release Branch
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.source_branch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Get current version
        id: current-version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Calculate new version
        id: new-version
        run: |
          if [ "${{ inputs.release_type }}" = "custom" ]; then
            if [ -z "${{ inputs.version }}" ]; then
              echo "‚ùå Version is required for custom releases"
              exit 1
            fi
            NEW_VERSION="${{ inputs.version }}"
          else
            # Auto-calculate version based on type
            CURRENT="${{ steps.current-version.outputs.current }}"
            IFS='.' read -r -a parts <<< "$CURRENT"
            MAJOR="${parts[0]}"
            MINOR="${parts[1]}"
            PATCH="${parts[2]}"
            
            case "${{ inputs.release_type }}" in
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              patch)
                PATCH=$((PATCH + 1))
                ;;
            esac
            
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          fi

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ New version will be: $NEW_VERSION"

      - name: Validate version
        run: |
          CURRENT="${{ steps.current-version.outputs.current }}"
          NEW="${{ steps.new-version.outputs.version }}"

          # Check version format
          if ! [[ "$NEW" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Invalid version format: $NEW"
            echo "Expected format: X.Y.Z (e.g., 1.2.0)"
            exit 1
          fi

          # Check if new version is greater than current
          if [ "$(printf '%s\n' "$NEW" "$CURRENT" | sort -V | head -n1)" = "$NEW" ] && [ "$NEW" != "$CURRENT" ]; then
            echo "‚ùå New version ($NEW) must be greater than current version ($CURRENT)"
            exit 1
          fi

          echo "‚úÖ Version validation passed"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update package.json version
        run: |
          VERSION="${{ steps.new-version.outputs.version }}"
          npm version "$VERSION" --no-git-tag-version
          echo "‚úÖ Updated package.json to version $VERSION"

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: release/v${{ steps.new-version.outputs.version }}
          base: main
          commit-message: "chore: bump version to ${{ steps.new-version.outputs.version }}"
          title: "Release v${{ steps.new-version.outputs.version }}"
          body: |
            ## üöÄ Release v${{ steps.new-version.outputs.version }}

            This PR was automatically created by the Create Release workflow.

            ### Changes
            - Version bumped from `${{ steps.current-version.outputs.current }}` to `${{ steps.new-version.outputs.version }}`
            - Release type: **${{ inputs.release_type }}**
            - Source branch: `${{ inputs.source_branch }}`

            ### Next Steps
            1. Review the changes
            2. Approve and merge this PR
            3. The release workflow will automatically:
               - Create Git tag `v${{ steps.new-version.outputs.version }}`
               - Generate changelog
               - Create GitHub Release
               - Publish to NPM
               - Merge back to develop

            ### Checklist
            - [ ] Version is correct
            - [ ] Tests are passing
            - [ ] Documentation is updated
            - [ ] Breaking changes documented (if any)
          labels: |
            release
            automated

      - name: Summary
        run: |
          echo "## ‚úÖ Release Branch Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Current Version**: ${{ steps.current-version.outputs.current }}" >> $GITHUB_STEP_SUMMARY
          echo "- **New Version**: ${{ steps.new-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Type**: ${{ inputs.release_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: release/v${{ steps.new-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Source**: ${{ inputs.source_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Pull Request**: ${{ steps.create-pr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review and merge the PR to trigger the release workflow." >> $GITHUB_STEP_SUMMARY
